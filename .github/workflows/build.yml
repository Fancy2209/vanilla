name: Build
on:
  push:
    paths-ignore:
    - 'README.md'
  pull_request:
    paths-ignore:
    - 'README.md'
jobs:
  linux:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install build-essential ninja-build cmake \
          libgles2-mesa-dev libegl1-mesa-dev
    
    - name: Install Qt 6
      run: |
        git clone git://code.qt.io/qt/qt5.git qt6
        cd qt6
        git switch 6.7.1
        perl init-repository --module-subset=qtbase,qtmultimedia,qtshadertools
        mkdir qt6-build
        cd qt6-build
        ../configure -prefix $GITHUB_WORKSPACE/AppDir/usr
        cmake --build . --parallel
        cmake --install .
    
    - name: Configure
      run: |
        cmake . -Bbuild -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/AppDir/usr
    
    - name: Build
      run: |
        cmake --build build
    
    - name: Deploy
      run: |
        cmake --install build
        cd ..
        cp ../client/com.mattkc.* AppDir/
        curl -fLOSs https://github.com/AppImage/AppImageKit/releases/download/13/AppRun-x86_64
        mv AppRun-x86_64 AppDir/AppRun
        chmod +x AppDir/AppRun
        appimagetool AppDir
    
    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v2.2.1
      with:
        path:
          Vanilla_U-x86_64.AppImage

      
